<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HED Validator - Browser Edition</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .tool-section {
            margin-bottom: 40px;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 20px;
        }
        
        .tool-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #2c5282;
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        input[type="text"], textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        
        textarea {
            min-height: 100px;
            font-family: monospace;
            resize: vertical;
        }
        
        button {
            background-color: #3182ce;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }
        
        button:hover {
            background-color: #2c5282;
        }
        
        button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
        }
        
        .results {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .results.success {
            background-color: #f0fff4;
            border: 1px solid #68d391;
            color: #22543d;
        }
        
        .results.error {
            background-color: #fed7d7;
            border: 1px solid #fc8181;
            color: #742a2a;
        }
        
        .results.warning {
            background-color: #fefcbf;
            border: 1px solid #f6e05e;
            color: #744210;
        }
        
        .loading {
            color: #666;
            font-style: italic;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success { background-color: #48bb78; }
        .status-error { background-color: #f56565; }
        .status-warning { background-color: #ed8936; }
        
        .help-text {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        
        .examples {
            background-color: #f7fafc;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.85em;
        }
        
        .examples strong {
            display: block;
            margin-bottom: 5px;
            color: #2d3748;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß† HED Validator - Browser Edition</h1>
        
        <!-- HED String Validation -->
        <div class="tool-section">
            <div class="tool-title">üîç HED String Validation</div>
            
            <div class="examples">
                <strong>Examples:</strong>
                ‚Ä¢ Valid: Event/Sensory-event, Red, Blue<br>
                ‚Ä¢ With grouping: (Event/Sensory-event, (Red, Large))<br>
                ‚Ä¢ Invalid: InvalidTag, AnotherInvalidTag
            </div>
            
            <label for="hedString">HED String:</label>
            <textarea id="hedString" placeholder="Enter HED string to validate...">Event/Sensory-event, Red, Blue</textarea>
            
            <label for="hedVersion1">HED Schema Version:</label>
            <select id="hedVersion1">
                <option value="8.4.0">8.4.0 (Standard)</option>
                <option value="8.3.0">8.3.0 (Standard)</option>
                <option value="8.5.0">8.5.0 (Standard)</option>
                <option value="8.4.0,lang_1.1.0">8.4.0 + Language Library</option>
                <option value="8.4.0,score_2.1.0">8.4.0 + Score Library</option>
            </select>
            
            <label>
                <input type="checkbox" id="checkWarnings1"> Check for warnings
            </label>
            
            <label for="definitions1">Definitions (optional, one per line):</label>
            <textarea id="definitions1" placeholder="(Definition/MyDef, (Red, Blue))&#10;(Definition/AnotherDef, (Event))"></textarea>
            
            <button onclick="validateHedString()">Validate HED String</button>
            
            <div id="stringResults" class="results" style="display: none;"></div>
        </div>
        
        <!-- TSV File Validation -->
        <div class="tool-section">
            <div class="tool-title">üìä TSV File Validation</div>
            
            <div class="examples">
                <strong>TSV Format Example:</strong>
                onset&nbsp;&nbsp;&nbsp;&nbsp;duration&nbsp;&nbsp;&nbsp;&nbsp;trial_type&nbsp;&nbsp;&nbsp;&nbsp;HED<br>
                1.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Event/Sensory-event, Red<br>
                3.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Event/Sensory-event, Blue
            </div>
            
            <label for="tsvData">TSV File Content:</label>
            <textarea id="tsvData" placeholder="Paste TSV content here...">onset	duration	trial_type	HED
1.0	2.0	go	Event/Sensory-event, Red
3.0	2.0	stop	Event/Sensory-event, Blue</textarea>
            
            <label for="hedVersion2">HED Schema Version:</label>
            <select id="hedVersion2">
                <option value="8.4.0">8.4.0 (Standard)</option>
                <option value="8.3.0">8.3.0 (Standard)</option>
                <option value="8.5.0">8.5.0 (Standard)</option>
            </select>
            
            <label>
                <input type="checkbox" id="checkWarnings2"> Check for warnings
            </label>
            
            <label for="sidecarData">Sidecar JSON (optional):</label>
            <textarea id="sidecarData" placeholder='{"trial_type": {"go": {"HED": "Action/Move"}}}'></textarea>
            
            <button onclick="validateTsvData()">Validate TSV Data</button>
            
            <div id="tsvResults" class="results" style="display: none;"></div>
        </div>
        
        <!-- Sidecar Validation -->
        <div class="tool-section">
            <div class="tool-title">üìÑ Sidecar JSON Validation</div>
            
            <div class="examples">
                <strong>Sidecar Format Example:</strong>
                {<br>
                &nbsp;&nbsp;"trial_type": {<br>
                &nbsp;&nbsp;&nbsp;&nbsp;"go": {"HED": "Event/Sensory-event, Green"},<br>
                &nbsp;&nbsp;&nbsp;&nbsp;"stop": {"HED": "Event/Sensory-event, Red"}<br>
                &nbsp;&nbsp;}<br>
                }
            </div>
            
            <label for="sidecarJson">Sidecar JSON Content:</label>
            <textarea id="sidecarJson" placeholder="Paste sidecar JSON here...">{
  "trial_type": {
    "go": {"HED": "Event/Sensory-event, Green"},
    "stop": {"HED": "Event/Sensory-event, Red"}
  }
}</textarea>
            
            <label for="hedVersion3">HED Schema Version:</label>
            <select id="hedVersion3">
                <option value="8.4.0">8.4.0 (Standard)</option>
                <option value="8.3.0">8.3.0 (Standard)</option>
                <option value="8.5.0">8.5.0 (Standard)</option>
            </select>
            
            <label>
                <input type="checkbox" id="checkWarnings3"> Check for warnings
            </label>
            
            <button onclick="validateSidecarData()">Validate Sidecar JSON</button>
            
            <div id="sidecarResults" class="results" style="display: none;"></div>
        </div>
    </div>

    <script>
        // This is a mock implementation for demonstration
        // In a real implementation, you'd need to:
        // 1. Bundle the HED validator for browsers
        // 2. Load HED schemas via fetch/AJAX
        // 3. Implement the actual validation logic
        
        let hedSchemas = {}; // Cache for loaded schemas
        
        // Mock HED validation functions
        function mockValidateHedString(hedString, hedVersion, checkWarnings = false, definitions = []) {
            // Simple mock validation
            const errors = [];
            const warnings = [];
            
            // Check for obviously invalid tags
            if (hedString.includes('InvalidTag')) {
                errors.push({
                    code: 'TAG_INVALID',
                    severity: 'error',
                    message: 'Invalid HED tag found',
                    location: hedString
                });
            }
            
            // Mock warning for extension tags
            if (checkWarnings && hedString.includes('MyCustom')) {
                warnings.push({
                    code: 'TAG_EXTENDED',
                    severity: 'warning', 
                    message: 'Extension tag used - consider more specific tag',
                    location: hedString
                });
            }
            
            return { errors, warnings };
        }
        
        function mockValidateTsv(tsvData, hedVersion, checkWarnings = false, sidecarData = null) {
            // Parse TSV data (simple implementation)
            const lines = tsvData.trim().split('\n');
            const headers = lines[0].split('\t');
            const hedIndex = headers.indexOf('HED');
            
            const errors = [];
            const warnings = [];
            
            if (hedIndex === -1) {
                return {
                    errors: [],
                    warnings: [],
                    message: 'No HED column found - nothing to validate'
                };
            }
            
            // Validate each row
            for (let i = 1; i < lines.length; i++) {
                const cells = lines[i].split('\t');
                const hedString = cells[hedIndex];
                
                if (hedString && hedString.trim()) {
                    const result = mockValidateHedString(hedString, hedVersion, checkWarnings);
                    errors.push(...result.errors.map(e => ({...e, line: i + 1})));
                    warnings.push(...result.warnings.map(w => ({...w, line: i + 1})));
                }
            }
            
            return { errors, warnings };
        }
        
        function mockValidateSidecar(jsonData, hedVersion, checkWarnings = false) {
            const errors = [];
            const warnings = [];
            
            try {
                const sidecar = JSON.parse(jsonData);
                
                // Recursively find HED strings in the sidecar
                function findHedStrings(obj, path = '') {
                    for (const [key, value] of Object.entries(obj)) {
                        const currentPath = path ? `${path}.${key}` : key;
                        
                        if (key === 'HED' && typeof value === 'string') {
                            const result = mockValidateHedString(value, hedVersion, checkWarnings);
                            errors.push(...result.errors.map(e => ({...e, location: currentPath})));
                            warnings.push(...result.warnings.map(w => ({...w, location: currentPath})));
                        } else if (typeof value === 'object' && value !== null) {
                            findHedStrings(value, currentPath);
                        }
                    }
                }
                
                findHedStrings(sidecar);
                
                return { 
                    errors, 
                    warnings, 
                    parsedHedSidecar: JSON.stringify(sidecar, null, 2) 
                };
            } catch (error) {
                return {
                    errors: [{
                        code: 'JSON_PARSE_ERROR',
                        severity: 'error',
                        message: 'Invalid JSON format: ' + error.message
                    }],
                    warnings: []
                };
            }
        }
        
        function showResults(elementId, result) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            
            let className = 'success';
            let statusIcon = '<span class="status-indicator status-success"></span>';
            let message = '';
            
            if (result.errors && result.errors.length > 0) {
                className = 'error';
                statusIcon = '<span class="status-indicator status-error"></span>';
                message = `${statusIcon}Validation failed with ${result.errors.length} error(s):\n\n`;
                result.errors.forEach((error, i) => {
                    message += `${i + 1}. [${error.code}] ${error.message}`;
                    if (error.location) message += ` (${error.location})`;
                    if (error.line) message += ` at line ${error.line}`;
                    message += '\n';
                });
            } else {
                message = `${statusIcon}Validation successful!`;
            }
            
            if (result.warnings && result.warnings.length > 0) {
                if (result.errors && result.errors.length === 0) {
                    className = 'warning';
                    statusIcon = '<span class="status-indicator status-warning"></span>';
                    message = `${statusIcon}Validation passed with ${result.warnings.length} warning(s):\n\n`;
                } else {
                    message += '\nWarnings:\n';
                }
                result.warnings.forEach((warning, i) => {
                    const num = (result.errors && result.errors.length > 0) ? i + 1 : i + 1;
                    message += `${num}. [${warning.code}] ${warning.message}`;
                    if (warning.location) message += ` (${warning.location})`;
                    if (warning.line) message += ` at line ${warning.line}`;
                    message += '\n';
                });
            }
            
            if (result.message) {
                message += '\n' + result.message;
            }
            
            element.className = `results ${className}`;
            element.innerHTML = message;
        }
        
        async function validateHedString() {
            const hedString = document.getElementById('hedString').value;
            const hedVersion = document.getElementById('hedVersion1').value;
            const checkWarnings = document.getElementById('checkWarnings1').checked;
            const definitionsText = document.getElementById('definitions1').value;
            
            const definitions = definitionsText.trim() 
                ? definitionsText.split('\n').map(d => d.trim()).filter(d => d)
                : [];
            
            // Show loading
            const resultsElement = document.getElementById('stringResults');
            resultsElement.style.display = 'block';
            resultsElement.className = 'results';
            resultsElement.innerHTML = '<span class="loading">üîÑ Validating HED string...</span>';
            
            // Mock delay to simulate API call
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const result = mockValidateHedString(hedString, hedVersion, checkWarnings, definitions);
            showResults('stringResults', result);
        }
        
        async function validateTsvData() {
            const tsvData = document.getElementById('tsvData').value;
            const hedVersion = document.getElementById('hedVersion2').value;
            const checkWarnings = document.getElementById('checkWarnings2').checked;
            const sidecarData = document.getElementById('sidecarData').value.trim() || null;
            
            // Show loading
            const resultsElement = document.getElementById('tsvResults');
            resultsElement.style.display = 'block';
            resultsElement.className = 'results';
            resultsElement.innerHTML = '<span class="loading">üîÑ Validating TSV data...</span>';
            
            // Mock delay
            await new Promise(resolve => setTimeout(resolve, 800));
            
            const result = mockValidateTsv(tsvData, hedVersion, checkWarnings, sidecarData);
            showResults('tsvResults', result);
        }
        
        async function validateSidecarData() {
            const jsonData = document.getElementById('sidecarJson').value;
            const hedVersion = document.getElementById('hedVersion3').value;
            const checkWarnings = document.getElementById('checkWarnings3').checked;
            
            // Show loading
            const resultsElement = document.getElementById('sidecarResults');
            resultsElement.style.display = 'block';
            resultsElement.className = 'results';
            resultsElement.innerHTML = '<span class="loading">üîÑ Validating sidecar JSON...</span>';
            
            // Mock delay
            await new Promise(resolve => setTimeout(resolve, 600));
            
            const result = mockValidateSidecar(jsonData, hedVersion, checkWarnings);
            showResults('sidecarResults', result);
        }
        
        // Add some keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    // Validate whatever section is focused
                    const activeElement = document.activeElement;
                    if (activeElement.closest('.tool-section')) {
                        const section = activeElement.closest('.tool-section');
                        const button = section.querySelector('button');
                        if (button) button.click();
                    }
                }
            }
        });
        
        console.log('üß† HED Validator Browser Edition loaded!');
        console.log('Note: This is a demo with mock validation. For production use, integrate with actual HED validator.');
    </script>
</body>
</html>
